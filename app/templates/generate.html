{% extends 'base.html' %}

{% block content %}
<h2>AI智能出题 (高级版)</h2>
<ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="chapter-tab" data-bs-toggle="tab" data-bs-target="#chapter" type="button">章节出题</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="similar-tab" data-bs-toggle="tab" data-bs-target="#similar" type="button">举一反三</button>
    </li>
</ul>

<div class="tab-content" id="myTabContent">
    <!-- Chapter Generation Mode -->
    <div class="tab-pane fade show active" id="chapter" role="tabpanel">
        <form method="POST" action="/questions/generate">
            <input type="hidden" name="mode" value="chapter">
            <input type="hidden" name="question_types_json" id="question_types_json" value="">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label>选择教材</label>
                    <select class="form-select" id="textbook_select">
                        <option value="">请选择教材</option>
                        {% for tb in textbooks %}
                        <option value="{{ tb.textbook_id }}">{{ tb.textbook_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label>选择章节</label>
                    <select class="form-select" name="chapter_id" id="chapter_select" required>
                        <option value="">请先选择教材</option>
                    </select>
                    <small class="text-muted">章节列表来自教材章节库（可在“教材管理→章节管理”上传章节内容）</small>
                </div>
            </div>
            
            <div class="row">
                 <div class="col-md-6 mb-3">
                    <label>题型与数量（可自定义题型名称）</label>
                    <div id="types_container" class="border rounded p-2">
                        <div class="row g-2 type-row mb-2">
                            <div class="col-8">
                                <input class="form-control type-name" value="选择题" placeholder="题型名称（可手动输入）">
                            </div>
                            <div class="col-4">
                                <input type="number" class="form-control type-count" value="5" min="1">
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="add_type_btn">+ 添加题型</button>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="remove_type_btn">- 删除最后一项</button>
                    </div>
                    <div class="text-muted mt-1">系统会按各题型数量自动计算占比并生成，总题数等于各题型数量之和。</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label>难度 (默认100%)</label>
                    <select name="difficulty" class="form-select">
                        <option value="简单">简单</option>
                        <option value="中等">中等</option>
                        <option value="困难">困难</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label>生成数量（自动计算）</label>
                    <input type="number" name="count" id="total_count" class="form-control" value="5" min="1" max="200" readonly>
                </div>
                <div class="col-md-4 mb-3">
                    <label>试卷总分</label>
                    <input type="number" name="total_score" class="form-control" value="100">
                </div>
                 <div class="col-md-4 mb-3">
                    <label>额外描述</label>
                    <input type="text" name="description" class="form-control" placeholder="例如：侧重考察概念理解">
                </div>
            </div>

            <div class="row">
                <div class="col-md-12 mb-3">
                    <label>标签 / 关键词（防跑题约束）</label>
                    <input type="text" name="tags_keywords" class="form-control" placeholder="例如：一元二次方程, 判别式, 韦达定理">
                    <small class="text-muted">会与章节内容一起作为约束输入给AI，要求紧扣这些关键词命题。</small>
                </div>
            </div>

            <div class="alert alert-info">
                <strong>提示：</strong> 本页已支持“题型名称 + 每种数量”的自定义；后端会自动换算占比并把章节内容作为上下文，减少跑题。
            </div>

            <button type="submit" class="btn btn-primary w-100">开始生成</button>
        </form>
    </div>

    <!-- Similar Question Mode -->
    <div class="tab-pane fade" id="similar" role="tabpanel">
        <form method="POST" action="/questions/generate">
            <input type="hidden" name="mode" value="similar">
            <div class="mb-3">
                <label>原题目ID</label>
                <input type="number" name="question_id" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">生成相似题</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updateTypesJsonAndCount() {
        let types = [];
        let total = 0;
        $('#types_container .type-row').each(function() {
            const name = $(this).find('.type-name').val().trim();
            const cnt = parseInt($(this).find('.type-count').val() || '0');
            if (name && cnt > 0) {
                types.push({name: name, count: cnt});
                total += cnt;
            }
        });
        $('#question_types_json').val(JSON.stringify(types));
        $('#total_count').val(total || 0);
    }

    $('#add_type_btn').click(function() {
        $('#types_container').append(`
            <div class="row g-2 type-row mb-2">
                <div class="col-8">
                    <input class="form-control type-name" placeholder="题型名称（可手动输入）">
                </div>
                <div class="col-4">
                    <input type="number" class="form-control type-count" value="1" min="1">
                </div>
            </div>
        `);
        updateTypesJsonAndCount();
    });

    $('#remove_type_btn').click(function() {
        const rows = $('#types_container .type-row');
        if (rows.length > 1) {
            rows.last().remove();
            updateTypesJsonAndCount();
        }
    });

    $(document).on('input', '.type-name,.type-count', function() {
        updateTypesJsonAndCount();
    });

    $('#textbook_select').change(function() {
        const tbId = $(this).val();
        $('#chapter_select').empty();
        if (!tbId) {
            $('#chapter_select').append(`<option value="">请先选择教材</option>`);
            return;
        }
        $('#chapter_select').append(`<option value="">加载中...</option>`);
        $.getJSON(`/api/textbooks/${tbId}/chapters`, function(items) {
            $('#chapter_select').empty();
            if (!items.length) {
                $('#chapter_select').append(`<option value="">该教材暂无章节，请先去章节管理添加</option>`);
                return;
            }
            $('#chapter_select').append(`<option value="">请选择章节</option>`);
            items.forEach(function(c) {
                const indent = '&nbsp;'.repeat((c.chapter_level - 1) * 4);
                $('#chapter_select').append(`<option value="${c.chapter_id}">${indent}${c.chapter_name} (ID:${c.chapter_id})</option>`);
            });
        }).fail(function() {
            $('#chapter_select').empty().append(`<option value="">章节加载失败</option>`);
        });
    });

    // init
    updateTypesJsonAndCount();
</script>
{% endblock %}
